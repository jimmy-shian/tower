<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Text Search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            }

            .search-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 20px 0 0;
            }

            .search-input {
            width: 55%;
            padding: 10px;
            margin: 10px 20px 10px 0;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            }

            .search-button {
            padding: 10px 25px;
            margin: 10px;
            width: auto;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            }

            .search-button:hover {
            background-color: #0056b3;
            }

            .table-container {
                display: flex;
                /* overflow-x: auto; */
                width: 98%;
            }
            .table {
            border: 4px double #000;
            /* max-width: auto; */
            /* overflow-x: auto; */
            /* resize: vertical; */
            border-collapse: collapse;
            width: 50%;
            /* max-height: 50px; */
            height: 100%;
            flex-direction: column;
            /* border: 4px double #000; */
            /* border: 1px solid #ccc; */
            margin: 10px;
        }

        .table-row {
            display: inline-flex;
            border-bottom: 1px solid #ccc;
            max-height: 600px;
            justify-content: center;
            align-items: center;
        }

        .table-cell {
            overflow-y: auto;
            height: 125px;
            padding: 15px;
            display: inline-grid;
            justify-content: center;
            border-right: 2px solid #c7c7c7;
        }

        .table-cell:last-child {
            border-right: none;
        }

        /* .table:first-child {
            border: 4px double #000;
        } */

        .image-wrapper {
            position: absolute;
            width: 40px; /* 與圖片寬度相同 */
            height: auto; /* 自動高度 */
            transition: transform 0.2s; /* 添加平滑過渡效果 */
            /* overflow-clip-margin: 0; */
        }

        .image-wrapper:hover {
            position: absolute;
            /* display: flex; */
            transform: scale(3); /* 將圖片放大到原尺寸的2倍 */
            z-index: 99;
        }

            .filter-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px;
            padding: 3px;
            }

            .checkbox-label {
            margin-top: 10px;
            justify-content: start;
            align-items: start;
            }

            #raceFilter,
            #attributeFilter {
            justify-content: start;
            align-items: start;
            width: 150px;
            height: 25px;
            border: 1px solid #000;
            }

    </style>

</head>
<body>
    <h1>JSON Text Search</h1>

    <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="輸入關鍵字..." onkeypress="handleKeyPress(event)">
      <button class="search-button" onclick="searchJSON()">搜尋</button>
    </div>

    <h2 style="margin-left: 20vh;">選擇搜尋欄位：</h2>
    <div class="filter-container">
        <div class="checkbox-label">
          <label class="checkbox-label"><input type="checkbox" data-field="Image Name" checked>卡片名稱</label>
          <label class="checkbox-label"><input type="checkbox" data-field="主動技效果" checked>主動技</label>
          <label class="checkbox-label"><input type="checkbox" data-field="隊長技效果">隊長技</label>
          <label class="checkbox-label"><input type="checkbox" data-field="Team Skills">隊伍技</label>
          <label class="checkbox-label"><input type="checkbox" data-field="最小CD">最小CD</label>
          <label class="checkbox-label"><input type="checkbox" data-field="最小EP">最小EP</label>
        
          <div class="checkbox-label">
            <label for="raceFilter" class="checkbox-label">選擇種族：</label>
            <select id="raceFilter" >
              <option value="all">所有種族</option>
              <option value="人類">人類</option>
              <option value="獸類">獸類</option>
              <option value="妖精類">妖精類</option>
              <option value="龍類">龍類</option>
              <option value="神族">神族</option>
              <option value="魔族">魔族</option>
              <option value="機械族">機械族</option>
              <option value="進化素材">進化素材</option>
              <option value="強化素材">強化素材</option>

            </select>
          </div>
          
          <div class="checkbox-label">
            <label for="attributeFilter" class="checkbox-label">選擇屬性：</label>
            <select id="attributeFilter" >
                <option value="all">所有屬性</option>
                <option value="水">水</option>
                <option value="火">火</option>
                <option value="木">木</option>
                <option value="光">光</option>
                <option value="暗">暗</option>
            </select>
          </div>
          
        </div>
      </div>

    <!-- 其他欄位選項 -->

    <div id="results"></div>
    
    <!-- <div class="table-container">
        <div class="table">
          <div class="table-row">
            <div class="table-cell">Cell 1</div>
            <div class="table-cell">Cell 2 with longer text that needs scrolling</div>
            <div class="table-cell">Cell 3</div>
          </div>
        </div>
      </div> -->

<div style="text-align: center; margin-top: 20px;">
    <!-- <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.zh_TW" target="_blank">
        <img alt="Creative Commons License" style="border-width:0; width: 120px;" src="https://i.creativecommons.org/l/by-sa/3.0/88x31.png" />
    </a><br> -->
    本作品資料來源為：
    <a rel="license" href="https://tos.fandom.com/zh/wiki/%E7%A5%9E%E9%AD%94%E4%B9%8B%E5%A1%94_%E7%B9%81%E4%B8%AD%E7%B6%AD%E5%9F%BA?variant=zh-tw" target="_blank">神魔之塔繁中維基</a>
    ，根據FANDOM社區使用條款以<a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/deed.zh_TW" target="_blank">
        <img alt="Creative Commons License" style="border-width:0; width: 80px;" src="https://i.creativecommons.org/l/by-sa/3.0/88x31.png" />
        (CC-BY-SA 3.0) </a>進行使用。
</div><br>

    <script>
        // var searchData = [];
        fetch('https://raw.githubusercontent.com/jimmy-shian/tower/main/final_data.json')
        .then(response => response.json()) // 解析 JSON 資料
            .then(data => {
                // 現在的 data 應該是一個陣列，可以進行迭代
                searchData = data; // 將解析後的資料指派給 searchData
                console.log('search data is loading');
            })
            .catch(error => {
                console.error('Error fetching or parsing final_data.json:', error);
        });
        fetch('https://raw.githubusercontent.com/jimmy-shian/tower/main/processed_data.json')
        .then(response => response.json()) // 解析 JSON 資料
            .then(data2 => {
                // 現在的 data 應該是一個陣列，可以進行迭代
                showData = data2; // 將解析後的資料指派給 searchData
                console.log('show data is loading');
            })
            .catch(error => {
                console.error('Error fetching or parsing processed_data.json:', error);
        });

        function searchJSON() {
            var searchKeyword = document.getElementById("searchInput").value.toLowerCase();
            var resultsDiv = document.getElementById("results");
            var selectedFields = getSelectedFields();
            var raceFilter = String(document.getElementById("raceFilter").value);
            var attributeFilter = String(document.getElementById("attributeFilter").value);
            resultsDiv.innerHTML = "";
            var filteredIndexes = [];
            var dataIndex = [];
            var dataIndex2 = [];

            var match = false;

            // 遍历 searchData 数组中的每个数据项，同时追踪索引
            searchData.forEach((item, index) => {
                selectedFields.forEach(field => {
                    var fieldValue = item[field.fieldName];
                    
                    if (fieldValue.includes(searchKeyword)) {
                        match = true;
                        if (match) {
                            console.log('ininininin');

                            console.log('屬性 attributeFilter', attributeFilter , '-', item["屬性"] );
                            console.log('種族 raceFilter', raceFilter , '-', item["種族"] );                            
                            // var attributeFilter = item["屬性"];
                            // var raceValues = item["種族"];
                            if (item["屬性"] == attributeFilter && item["種族"] == raceFilter) {
                                dataIndex.push(index);
                                console.log('1');
                                }
                            else if (item["屬性"] == attributeFilter && raceFilter == 'all') {
                                dataIndex.push(index);
                                console.log('2');
                                }
                            else if (attributeFilter == 'all' && item["種族"] == raceFilter) {
                                dataIndex.push(index);
                                console.log('3');
                            }
                            else if (attributeFilter == 'all' && raceFilter == 'all') {
                                dataIndex.push(index);
                                console.log('4');
                            }
                            else
                                console.log('Not find');
                        }
                        // filteredIndexes.push(index);
                        console.log(dataIndex);
                        console.log(raceFilter, attributeFilter);
                        console.log(match);
                    }
                });
            });
                
            dataIndex.forEach((index,item) => {
                    dataIndex2 = showData[index]; // 获取 showData 中的索引值对应的数据项索引
                    var resultItem = document.createElement("div");
                    // 将数据项转换为文本，并设置为 resultItem 的文本内容
                    dataIndex2 = String(dataIndex2);

                    if (dataIndex2.startsWith("{'") && dataIndex2.endsWith("'}")) {
                        dataIndex2 = dataIndex2.substring(2, dataIndex2.length - 2);
                    }
                    // 设置 resultItem 的 HTML 内容
                        resultItem.innerHTML = dataIndex2;
                        console.log('finish');
                        resultsDiv.appendChild(resultItem);
                    });
 
        }

        function highlightKeywords(text, keyword) {
            // 将搜索关键字拆分为字符数组
            var searchCharacters = keyword.split('');
            var currentIndex = 0;

            // 将文本中匹配的字符用 <mark> 标签进行高亮处理
            var highlightedText = text.replace(/./g, char => {
                if (char.toLowerCase() === searchCharacters[currentIndex]) {
                    currentIndex++;
                    return `<mark>${char}</mark>`;
                } else {
                    return char;
                }
            });

            return highlightedText;
        }


        // function getSelectedFields() {
        //     var selectedFields = [];
        //     var checkboxes = document.querySelectorAll("input[type=checkbox]:checked");

        //     checkboxes.forEach(checkbox => {
        //         var fieldName = checkbox.getAttribute("data-field");

        //         selectedFields.push({
        //             fieldName: fieldName
        //         });
        //     });

        //     return selectedFields;
        // }
        function getSelectedFields() {
            var selectedFields = [];
            // var checkboxCD = document.getElementById("checkbox-cd");
            // var checkboxEP = document.getElementById("checkbox-ep");
            var checkboxes = document.querySelectorAll("input[type=checkbox]:checked");

            checkboxes.forEach(checkbox => {
                var fieldName = checkbox.getAttribute("data-field");

                selectedFields.push({
                    fieldName: fieldName
                });
            });

            // if (checkboxCD.checked) {
            //     selectedFields.push({
            //         fieldName: checkboxCD.getAttribute("data-field")
            //     });
            // }
            // if (checkboxEP.checked) {
            //     selectedFields.push({
            //         fieldName: checkboxEP.getAttribute("data-field")
            //     });
            // }

        return selectedFields;
    }
        // ... 其他代码

        function handleKeyPress(event) {
            if (event.keyCode === 13) {
                searchJSON(); // 在按下 Enter 键时触发搜索功能
            }
        }


// ... 其他代码

    </script>
</body>
</html>
